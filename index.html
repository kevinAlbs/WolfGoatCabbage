<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Wolf, Goat, Cabbage</title>
    <meta name="description" content="">
    <meta name="author" content="Kevin Albertson">

    <style type="text/css">
    </style>

    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<body>
    <div id="game"></div>
    <script src="js/phaser.min.js"></script>
    <script>
        var game = new Phaser.Game(900, 450, Phaser.AUTO, "game", {
            preload: preload,
            create: create,
            update: update
        }, false, false, null);
        
        var bg, bgNight;
        var kLakeStartX = 140, kLakeEndX = 360;
        var kBarnStartX = 768, kBarnStepStartX = 747;
        var kCamBeforeFarm = 550 - 300, kCamAfterFarm = 800 - 300, kCamBarn = 800;
        var kGroundY = 89;

        var farmer = {
            state: {
                dir: 1,
                frameIndex: 0,
                boat: "not_in", // in
                body: "idle", // walking, stairsUp, stairsDown
                pickingUp: "none", // goat, wolf, cabbage, gun
                x: 100,
                y: 80,
                onStairs: false,
                floor: 1
            },
            kFrames: {
                "idle": [0],
                "walking": [1, 2, 3, 4, 5, 6]
            },
            body: null,
            sprite: null,
            deathBody: null,
            shadow: null,
            width: 20
        };

        var goat = {
            state: {
                dir : 1,
                body: "idle", // walking, eating, held, dead
                boat: "not_in",
                x: 50,
                y: 88
            },
            sprite: null,
        };

        var cabbage = {
            state: {
                boat: "not_in",
                x: 82,
                y: 93
            },
            sprite: null,
        };

        var wolf = {
            state: {
                dir : 1,
                body: "idle", // walking, eating, held
                boat: "not_in",
                x: 20,
                y: 94
            },
            sprite: null,
        };

        var boat = {
            state: {
                body: "idle", // moving
                dir: 1,
                side: "left", // center/right
                yOffset: 0,
                x: 178,
                y: 95
            },
            sprite: null,
        };

        var gun = {
            sprite: null
        };

        var textDisplay = {
            graphics: null,
            text: null, // Currently displayed text.
            newText: null, // Text requested to display this frame.
            bitmapText: null,
        };

        var actors = new Map([["farmer", farmer], ["goat", goat], ["cabbage", cabbage], ["wolf", wolf]]);

        var keysDownHandled = {};

        var targetCameraX = 0;

        var endingState = "none"; // wolf_eats_goat, goat_eats_cabbage

        var title = {
            showing: false,
            group: null
        };

        var restartState = null;
        
        var transition = {
            active: false,
            timer: 0,
            callback: null
        };
        
        var gameState = {
            day: 1,
            screen: "outside", // barn
            sky: {
                changing: false,
                timeToNight: 60 * 1000
            },
            endSequence : {
                active: false,
                step: 0,
                decrementTimer: 0,
                rate: 1000, // rate at which clock step decreases. Decreases as step increases.
                highlightTimer: 0, // highlights the (space)
            }
        };

        var backgroundMusic = null, audioKeyPlaying = "", audioPlaying = null;

        // Once a text is shown it stays shown until this method is not called.
        // Ignore calls to this if the game is in an ending state.
        function showText(msg) {
            if (endingState == "none") textDisplay.newText = msg;
        }

        // Returns true if this keycode is down. If it returns true, it will wait until it is released
        // and re-pressed before returning true again.
        function isPressed(keycode) {
            if (game.input.keyboard.isDown(keycode)) {
                if (keysDownHandled[keycode]) {
                    return false;
                } else {
                    keysDownHandled[keycode] = true;
                    return true;
                }
            }
        }

        function isFinished() {
            return goat.state.x > kLakeEndX &&
                cabbage.state.x > kLakeEndX && wolf.state.x > kLakeEndX;
        }

        function playIfNotPlaying(key) {
            if (audioKeyPlaying != key) {
                // Stop all sounds.
                backgroundMusic.stop();
                audioPlaying = backgroundMusic.play(key);
                audioKeyPlaying = key;

            }
        }

        // Idempotent.
        function showTitle(msg, restart) {
            if (restart && isPressed(Phaser.KeyCode.SPACEBAR)) {
                if (title.showing) title.group.destroy();
                title.showing = false;
                restartGame();
                return;
            }
            if (title.showing) return;
            title.showing = true;
            title.group = game.add.group();
            title.group.add(game.add.sprite(10, 10, "title"));
            if (msg) title.group.add(game.add.bitmapText(85, 12, "font", msg, 16));
            if (restart) title.group.add(
                game.add.bitmapText(10, 30, "font", "(space) to restart", 16));
            title.group.x = game.camera.x / game.camera.scale.x;
        }
        // Called at the end of the frame.
        function updateText() {
            // If the text display has been created or changed, we need to re-render.
            if (textDisplay.newText) {
                if (textDisplay.newText != textDisplay.text) {
                    // Display created/changed text.
                    if (textDisplay.graphics) textDisplay.graphics.destroy();
                    textDisplay.graphics = game.add.graphics(0, 0);
                    textDisplay.graphics.beginFill(0x000000);
                    textDisplay.graphics.drawRect(10, 130, 280, 11);
                    textDisplay.graphics.endFill();
                    textDisplay.bitmapText = game.add.bitmapText(12, 127, "font", textDisplay.newText, 16);
                    textDisplay.graphics.addChild(textDisplay.bitmapText);
                    textDisplay.text = textDisplay.newText;
                }
            } else {
                // Otherwise, if the text display was null, delete.
                if (textDisplay.graphics) textDisplay.graphics.destroy();
                textDisplay.text = null;
            }

            if (gameState.endSequence.active && textDisplay.bitmapText) {
                var diff = Math.min(255, Math.floor(255 * gameState.endSequence.step  / 70));
                if (gameState.endSequence.highlightTimer > 0) {
                    diff = Math.max(diff, 255 * gameState.endSequence.highlightTimer / 250);
                }
                textDisplay.bitmapText.tint = 0xFF0000 | (0xFF - diff) | ((0xFF - diff) << 8);
            }

            // Update position of graphics.
            if (textDisplay.graphics) textDisplay.graphics.x = game.camera.x / game.camera.scale.x;
            textDisplay.newText = null;
        }

        function restartGame() {
            game.camera.x = 0;
            endingState = "none";
            setCompleteState(restartState);
        }

        // TODO: optimize.
        function deepCopy(obj) {
            return Phaser.Utils.extend(true, {}, obj);
        }

        function getCompleteState() {
            return {
                farmer: deepCopy(farmer.state),
                cabbage: deepCopy(cabbage.state),
                wolf: deepCopy(wolf.state),
                goat: deepCopy(goat.state),
                boat: deepCopy(boat.state),
                gameState: deepCopy(gameState)
            }
        }

        function setCompleteState(state) {
            farmer.state = deepCopy(state.farmer);
            cabbage.state = deepCopy(state.cabbage);
            wolf.state = deepCopy(state.wolf);
            goat.state = deepCopy(state.goat);
            boat.state = deepCopy(state.boat);
            gameState = deepCopy(state.gameState);
        }

        function tempSet() {
            wolf.state.x = kLakeEndX + 10;
            goat.state.x = kLakeEndX + 10;
            cabbage.state.x = kLakeEndX + 10;
            farmer.state.x = kLakeEndX + 40;
        }

        function saveState() {
            window.localStorage.setItem("state", JSON.stringify(getCompleteState()));
        }

        function loadState() {
            var state = JSON.parse(window.localStorage.getItem("state"));
            if (state) {
                setCompleteState(state);
            }
        }
        
        function clearState() {
            window.localStorage.removeItem("state");
        }

        // Applies boat offset if on boat.
        function yPos(actor) {
            return actor.state.y + (actor.state.boat == "in" ? boat.state.yOffset : 0);
        }

        function capX(actor, lower, upper) {
            var hw = actor.sprite.width / 2;
            if (actor.state.x - hw < lower) actor.state.x = lower + hw;
            if (actor.state.x + hw > upper) actor.state.x = upper - hw;
        }

        function preload() {
            game.load.image("title", "img/title.png");
            game.load.image("bg-night", "img/bg-night.png");
            game.load.image("bg", "img/bg.png?v2");
            game.load.image("farmer-shadow", "img/farmer-shadow.png");
            game.load.image("goat", "img/goat.png");
            game.load.image("wolf", "img/wolf.png");
            game.load.image("cabbage", "img/cabbage.png");
            game.load.image("boat", "img/boat.png?v2");
            game.load.spritesheet("farmer", "img/farmer.png", 20, 44);
            game.load.bitmapFont("font", "img/font.png", "img/font.fnt");
            game.load.image("barn-front", "img/barn-front.png");
            game.load.image("gun", "img/gun.png");
            game.load.spritesheet("farmer-death", "img/farmer-death.png?v3", 70, 53);
            game.load.audioSprite("music", "snd/music.mp3", "snd/music-meta.json?v3");
        }

        function create() {
            restartState = getCompleteState();

            game.camera.scale.set(3, 3);
            game.camera.bounds = null;
    
            bgNight = game.add.sprite(0, 0, "bg-night");
            bg = game.add.sprite(0, 0, "bg");

            // Since sprite is updated with state, initial position is overwritten on first frame.
            goat.sprite = game.add.sprite(0, 0, "goat");
            goat.sprite.anchor.set(.5, .5);

            cabbage.sprite = game.add.sprite(0, 0, "cabbage");
            cabbage.sprite.anchor.set(.5, .5);

            wolf.sprite = game.add.sprite(0, 0, "wolf");
            wolf.sprite.anchor.set(.5, .5);

            farmer.sprite = game.add.group();
            farmer.body = game.add.sprite(0, 0, "farmer");
            farmer.body.anchor.set(.5, .5);
            farmer.body.animations.add("idle", [0]);
            farmer.body.animations.add("walking", [1,2,3,4,5,6], 6);
            farmer.shadow = farmer.sprite.create(-8, 16, "farmer-shadow");
            farmer.sprite.add(farmer.body);
            farmer.deathBody = game.add.sprite(0, -2, "farmer-death");
            farmer.deathBody.anchor.set(.5, .5);
            farmer.deathBody.animations.add("death", [13, 14, 15, 16, 17, 18, 19], 8, false);
            farmer.sprite.add(farmer.deathBody);

            boat.sprite = game.add.sprite(0, 0, "boat");
            boat.sprite.anchor.set(.5, .5);

            game.input.keyboard.onUpCallback = function(keyEvent) {
                keysDownHandled[keyEvent.keyCode] = false;
            };
            
            game.add.sprite(755, 35, "barn-front");

            gun.sprite = game.add.sprite(826, 111, "gun");
            gun.sprite.anchor.set(.5, .5);

            backgroundMusic = game.add.audioSprite("music");

            loadState();
        }

        function farmerTick() {
            var fx = farmer.state.x;
            var fhw = farmer.width / 2;

            // Check for state transitions.
            if (!farmer.state.onStairs) {
                if (farmer.state.body == "walking")
                    farmer.state.x = fx = fx + farmer.state.dir * .03 * game.time.elapsed;
                // Check if farmer should start walking.
                if (game.input.keyboard.isDown(Phaser.KeyCode.RIGHT)) {
                    farmer.state.dir = 1;
                    farmer.state.body = "walking";
                } else if (game.input.keyboard.isDown(Phaser.KeyCode.LEFT)) {
                    farmer.state.dir = -1;
                    farmer.state.body = "walking";
                } else {
                    farmer.state.body = "idle";
                }
            }
            
            // Check if farmer is in the boat.
            if (farmer.state.boat == "not_in") {
                farmer.shadow.visible = true;
                var leftDiff = (fx + fhw) - kLakeStartX;
                var rightDiff = kLakeEndX - (fx - fhw);
                if (rightDiff > 0 && leftDiff > 0) {
                    var boatFilled = false;
                    actors.forEach((actor) => {
                        boatFilled = boatFilled || actor.state.boat == "in";
                    });
                    if (leftDiff < rightDiff) {
                        // Farmer is attempting to get in from the left end of the lake.
                        // The farmer cannot get in with an additional item.
                        if (boat.state.side != "left" || (farmer.state.pickingUp != "none" && boatFilled)) {
                            fx = farmer.state.x = kLakeStartX - fhw;
                        } else {
                            fx = farmer.state.x = boat.state.x - 20;
                            farmer.state.boat = "in";
                        }
                    } else {    
                        // The farmer cannot get in with an additional item.
                        if (boat.state.side != "right" || (farmer.state.pickingUp != "none" && boatFilled)) {
                            fx = farmer.state.x = kLakeEndX + fhw;
                        } else {
                            fx = farmer.state.x = boat.state.x + 20;
                            farmer.state.boat = "in";
                        }
                    }
                }
            } 
            if (farmer.state.boat == "in") {
                farmer.shadow.visible = false;
                // Check if farmer can get out of boat.
                var bx = boat.state.x;
                var bhw = boat.sprite.width / 2;

                // If the boat is moving, keep the farmer inside.
                if (boat.state.body == "moving") capX(farmer, bx - bhw, bx + bhw);

                if (fx - fhw <= bx - bhw) {
                    if (boat.state.side == "left") {
                        farmer.state.boat = "not_in";
                        farmer.state.x = kLakeStartX - fhw;
                    } else {
                        farmer.state.x = fx = bx - bhw + fhw;
                        if (boat.state.body == "idle" && farmer.state.pickingUp == "none") {
                            showText("Press (space) to ride boat");
                            if (isPressed(Phaser.KeyCode.SPACEBAR)) {
                                boat.state.body = "moving";
                                boat.state.side = "center";
                                boat.state.dir = -1;
                            }
                        }
                    }
                } else if (fx + fhw >= bx + bhw) {
                    if (boat.state.side == "right") {
                        farmer.state.boat = "not_in";
                        farmer.state.x = kLakeEndX + fhw;
                    } else {
                        farmer.state.x = fx = bx + bhw - fhw;
                        if (boat.state.body == "idle" && farmer.state.pickingUp == "none") {
                            showText("Press (space) to ride boat");
                            if (isPressed(Phaser.KeyCode.SPACEBAR)) {
                                boat.state.body = "moving";
                                boat.state.side = "center";
                                boat.state.dir = 1;
                            }
                        }
                    }
                }
            }

            if (gameState.day == 1) {
                if (farmer.state.pickingUp == "none") {
                    actors.forEach((actor, actorName) => {
                        if (actorName == "farmer") return;
                        if (isFinished()) return;
                        if (Math.abs(farmer.state.x - actor.state.x) < 4) {
                            showText("Press (space) to pick up " + actorName)
                            if (isPressed(Phaser.KeyCode.SPACEBAR)) {
                                farmer.state.pickingUp = actorName;
                                actor.state.body = "held";
                            }
                        }    
                    });
                } else {
                    showText("Press (space) to drop " + farmer.state.pickingUp);
                    if (isPressed(Phaser.KeyCode.SPACEBAR)) {
                        var actor = actors.get(farmer.state.pickingUp);
                        actor.state.body = "idle";
                        farmer.state.pickingUp = "none";
                    }
                }
            } else {
                if (farmer.state.pickingUp == "none") {
                    var gx = gun.sprite.x, ghw = gun.sprite.width / 2;
                    if (farmer.state.x > gx - ghw && farmer.state.x < gx + ghw) {
                        showText("Press (space) to pick up gun");
                        if (isPressed(Phaser.KeyCode.SPACEBAR)) {
                            farmer.state.pickingUp = "gun";
                        }
                    }
                }
            }
            
            // Check if farmer is inside the barn.
            if (gameState.screen == "outside") {
                farmer.state.y = 80;
                if (farmer.state.x > kBarnStartX) {
                    // The first time the farmer enters the barn the sky turns.
                    gameState.sky.active = true;
                    gameState.screen = "barn";
                    farmer.state.x = kCamBarn + 10;
                } else if (farmer.state.x > kBarnStepStartX) {
                    farmer.state.y = 73;
                    farmer.shadow.visible = false;
                }
            } else if (gameState.screen == "barn") {
                farmer.shadow.visible = false;
                if (!farmer.state.onStairs) farmer.state.y = farmer.state.floor == 1 ? 125 : 50;
                if (farmer.state.x <= kCamBarn && farmer.state.floor == 1) {
                    farmer.state.x = kBarnStartX - 1;
                    gameState.screen = "outside";
                }
            }
            
            // Check if farmer is on stairs.
            if (!farmer.state.onStairs) {
                if (farmer.state.x >= 1000 && farmer.state.x < 1012 && isPressed(Phaser.KeyCode.UP)) {
                    farmer.state.onStairs = true;
                } else if (farmer.state.x >= 1040 && farmer.state.x <= 1060 && isPressed(Phaser.KeyCode.DOWN)) {
                    farmer.state.onStairs = true;
                }
            }
            
            if (farmer.state.floor == 2 && gameState.day == 1 && farmer.state.x > 820 && farmer.state.x < 890) {
                if (gameState.sky.timeToNight < 50000) {
                    showText("Press (space) to sleep");
                    if (isPressed(Phaser.KeyCode.SPACEBAR)) {
                        gameState.day = 2;
                        boat.state.x = kLakeStartX + boat.sprite.width / 2;
                        boat.state.side = "left";
                    }
                } else {
                    showText("Too early to sleep");
                }
            }
            
            if (farmer.state.onStairs) {
                if (game.input.keyboard.isDown(Phaser.KeyCode.UP)) {
                    farmer.state.dir = 1;
                    farmer.state.x += .015 * game.time.elapsed;
                    farmer.state.y -= .025 * game.time.elapsed;
                    if (farmer.state.y <= 50) {
                        farmer.state.onStairs = false;
                        farmer.state.floor = 2;
                    }
                } else if (game.input.keyboard.isDown(Phaser.KeyCode.DOWN)) {
                    farmer.state.dir = -1;
                    farmer.state.x -= .015 * game.time.elapsed;
                    farmer.state.y += .025 * game.time.elapsed;
                    if (farmer.state.y >= 125) {
                        farmer.state.onStairs = false;
                        farmer.state.floor = 1;
                    }
                }
            }

            farmer.deathBody.visible = false;
            farmer.body.visible = true;

            // If on death area, show death body.
            if (farmer.state.pickingUp == "gun") {
                gun.sprite.visible = false;
                if (farmer.state.x < kLakeEndX + fhw + 20) {
                    if (farmer.state.body == "idle") {
                        farmer.body.visible = false;
                        farmer.deathBody.visible = true;
                    }
                    showText("Press (space) to end it");
                    if (isPressed(Phaser.KeyCode.SPACEBAR)) {
                        gameState.endSequence.active = true;
                    }
                }
            }
            
            // Apply farmer state to farmer sprite.
            farmer.body.scale.set(farmer.state.dir, 1);
            farmer.deathBody.scale.set(farmer.state.dir, 1);
            farmer.body.animations.play(farmer.state.body) // idempotent.
            farmer.sprite.position.x = farmer.state.x;
            farmer.sprite.position.y = yPos(farmer);
        }

        // Assumes y positions have been set for actors.
        function boatTick() {
            var bx = boat.state.x, bhw = boat.sprite.width / 2;
            // Check for state transitions.
            // Move everything on the boat up and down.
            boat.state.yOffset = Math.sin(game.time.elapsedSince(0) * .005) / 2;

            if (boat.state.body == "moving") {
                var deltaX = boat.state.dir * game.time.elapsed * .05;
                // TODO: Breaks implicit rule that each state method changes only state of owned actor.
                actors.forEach((actor) => {
                    actor.state.x += actor.state.boat == "in" ? deltaX : 0;
                });
                bx = boat.state.x = bx + deltaX;
                if (boat.state.dir == 1) {
                    if (bx > kLakeEndX - bhw) {
                        boat.state.side = "right";
                        boat.state.body = "idle";
                    }
                } else {
                    if (bx < kLakeStartX + bhw) {
                        boat.state.side = "left";
                        boat.state.body = "idle";
                    }
                }
            }

            // Apply boat state to boat sprite.
            boat.sprite.position.x = boat.state.x;
            boat.sprite.position.y = boat.state.y + boat.state.yOffset;
        }

        function animalTick() {
            // Check for state transitions.
            if (gameState.day == 2) {
                wolf.sprite.visible = false;
                goat.sprite.visible = false;
                cabbage.sprite.visible = false;
                return;
            }
            // Apply properties common to all animals.
            actors.forEach((actor, actorName) => {
                if (actorName == "farmer") return;
                if (actor.state.body == "held") {
                   actor.state.boat = farmer.state.boat;
                   actor.state.x = farmer.sprite.position.x;
                   actor.state.y = 75;
                } else {
                   actor.state.y = 88;
                }
            });

            if (boat.state.body == "moving") {
                var side = (actor) => { return actor.state.x <= kLakeStartX; }
                if (side(wolf) == side(goat) && wolf.state.boat == "not_in" && goat.state.boat == "not_in") {
                    endingState = "wolf_eats_goat";
                }
                if (side(goat) == side(cabbage) && goat.state.boat == "not_in" && cabbage.state.boat == "not_in") {
                    endingState = "goat_eats_cabbage";
                }
            }

            if (wolf.state.body == "walking") {
                var diff = goat.state.x - wolf.state.x;
                if (Math.abs(diff) > 10) {
                    wolf.dir = Math.sign(diff);
                    wolf.state.x += .05 * wolf.state.dir * game.time.elapsed;
                } else {
                    wolf.state.body = "eating";
                    goat.state.body = "dead";
                }
            } else if (wolf.state.body == "eating") {
                // Show title screen once goat is completely eaten.
                showTitle("Wolves eat goats.", true);
            }

            if (goat.state.body == "walking") {
                var diff = cabbage.state.x - goat.state.x;
                if (Math.abs(diff) > 5) {
                    goat.state.dir = Math.sign(diff);
                    goat.state.x += .05 * goat.state.dir * game.time.elapsed;
                } else {
                    goat.state.body = "eating";
                    cabbage.state.body = "dead";
                }
            } else if (goat.state.body == "eating") {
                showTitle("Goats eat cabbages.", true);
            }

            // Apply states common to all.
            actors.forEach((actor, actorName) => {
                if (actorName == "farmer") return;
                actor.sprite.position.x = actor.state.x;
                actor.sprite.position.y = yPos(actor);
            });
            cabbage.sprite.scale.set(1, cabbage.state.body == "dead" ? -1 : 1);
            goat.sprite.scale.set(goat.state.dir, goat.state.body == "dead" ? -1 : 1);
            wolf.sprite.scale.set(wolf.state.dir, 1);
        }
        
        function skyTick() {
            if (gameState.day == 1) {
                if (gameState.sky.active) {
                    gameState.sky.timeToNight -= game.time.elapsed;
                    var opacity = gameState.sky.timeToNight / (60 * 1000);
                    opacity = Math.max(0, opacity);
                    bg.alpha = opacity;
                }
            } else {
                bg.alpha = 1;
            }
        }

        function endSequenceTick() {
            function finished() {
                return gameState.endSequence.step >= 70;
            }

            function inRange(lower, higher) {
                return gameState.endSequence.step >= lower && gameState.endSequence.step < higher;
            }

            farmer.body.visible = false;
            farmer.deathBody.visible = true;

            if (!finished()) {
                showText("Press (space) to end it");
                farmer.deathBody.frame = 1;
                gameState.endSequence.highlightTimer -= game.time.elapsed;
                gameState.endSequence.decrementTimer -= game.time.elapsed;
                if (gameState.endSequence.decrementTimer <= 0) {
                    gameState.endSequence.decrementTimer = gameState.endSequence.rate;
                    gameState.endSequence.step = Math.max(0, gameState.endSequence.step - 1);
                }
                gameState.endSequence.rate = 1000 - (gameState.endSequence.step / 70) * 850;

                if (isPressed(Phaser.KeyCode.SPACEBAR)) {
                    gameState.endSequence.step++;
                    gameState.endSequence.highlightTimer = 250;
                    // Increment farmer sprite animation by number of presses.
                    // TODO: Change based on rate.
                }

                if (inRange(5, 10)) {
                    farmer.deathBody.frame = 2;
                } else if (inRange(10, 15)) {
                    farmer.deathBody.frame = 3;
                } else if (inRange(15, 20)) {
                    farmer.deathBody.frame = 4;
                } else if (inRange(20, 25)) {
                    farmer.deathBody.frame = 5;
                } else if (inRange(25, 30)) {
                    farmer.deathBody.frame = 6;
                } else if (inRange(30, 35)) {
                    farmer.deathBody.frame = 7;
                } else if (inRange(35, 40)) {
                    farmer.deathBody.frame = 8;
                } else if (inRange(40, 45)) {
                    farmer.deathBody.frame = 9;
                } else if (inRange(45, 50)) {
                    farmer.deathBody.frame = 10;
                } else if (inRange(50, 55)) {
                    farmer.deathBody.frame = 11;
                } else if (inRange(55, 70)) {
                    farmer.deathBody.frame = 12;
                }

                game.camera.shake(.0001 * gameState.endSequence.step, 100, true, Phaser.Camera.SHAKE_HORIZONTAL);
            } else {
                // Wait one sec. TODO.

                // Play shot animation
                if (farmer.deathBody.frame <= 12) {
                    farmer.deathBody.animations.play("death");
                }

                // Wait one sec.
                // End of game.
                showTitle("", false);
                game.camera.shake(0, 0, true);
                //gameState.endSequence.active = false;
            }

            console.log(gameState.endSequence.step);
        }

        function update() {
            if (game.time.elapsed > 1000) return;
            if (gameState.endSequence.active) {
                endSequenceTick();
            } else {
                boatTick();
                farmerTick();
                animalTick();
                skyTick();
            }

            // Play background music.
            if (gameState.day == 1) {
                if (gameState.screen == "outside")
                    playIfNotPlaying("bg");
            } else {
                if (gameState.endSequence.active) {
                    if (audioKeyPlaying == "reverseNoise") {
                        if (!audioPlaying.isPlaying) {
                            playIfNotPlaying("noise");
                        }
                    } else if (audioKeyPlaying != "noise"){
                        playIfNotPlaying("reverseNoise");
                    }
                } else if (gameState.screen == "outside") {
                    playIfNotPlaying("reverse");
                }
            }
            
            switch(endingState) {
                case "none":
                    if (farmer.sprite.position.x > kLakeStartX + 65) {
                        targetCameraX = farmer.state.x * 3 - 450;
                    } else {
                        targetCameraX = 0;
                    }
                    break;
                case "wolf_eats_goat":
                    if (wolf.state.body == "idle" && farmer.state.x > kLakeStartX + 120) {
                        wolf.state.body = "walking";
                    }
                    if (wolf.state.x > kLakeStartX) {
                        targetCameraX = wolf.state.x * 3 - 450;
                    }
                    break;
                case "goat_eats_cabbage":
                    if (goat.state.body == "idle" && farmer.state.x > kLakeStartX + 120) {
                        goat.state.body = "walking";
                    }
                    if (goat.state.x > kLakeStartX) {
                        targetCameraX = goat.state.x * 3 - 450;
                    }
                    break;
            }

            var camDiff = targetCameraX - game.camera.x;
            if (Math.abs(camDiff) < .01) {
                game.camera.x = targetCameraX;
            } else {
                game.camera.x += game.time.elapsed * camDiff * .002;
            }

            // Clamp camera offset.
            var leftEnd = 0;
            if (gameState.screen == "barn") {
                leftEnd = 3 * kCamBarn;
            }
            game.camera.x = Math.max(leftEnd, game.camera.x);

            // Based on state, set camera right end. TODO: make this a hard clamping.
            var rightEnd = 0;
            if (gameState.screen == "barn") {
                rightEnd = 3 * kCamBarn;
            } else if (gameState.screen == "outside") {
                rightEnd = 3 * kCamBeforeFarm;
                if (isFinished()) {
                    rightEnd = 3 * kCamAfterFarm;
                }
            }
            game.camera.x = Math.min(rightEnd, game.camera.x);

            updateText();
        }
        
    </script>
</body>
</html>